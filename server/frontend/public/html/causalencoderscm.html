<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ºä»€ä¹ˆéœ€è¦ Î¼ å’Œ log(ÏƒÂ²)ï¼Ÿ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: white;
            font-size: 2.5em;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .control-group label {
            font-weight: 600;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .control-group .value {
            color: #667eea;
            font-size: 1.2em;
            font-weight: bold;
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }
        
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .comparison-item {
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #ddd;
        }
        
        .comparison-item.deterministic {
            background: #ffe6e6;
            border-color: #ff6b6b;
        }
        
        .comparison-item.probabilistic {
            background: #e6f3ff;
            border-color: #4dabf7;
        }
        
        .comparison-item h3 {
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        
        .comparison-item.deterministic h3 {
            color: #ff6b6b;
        }
        
        .comparison-item.probabilistic h3 {
            color: #4dabf7;
        }
        
        .formula {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 1.1em;
            text-align: center;
            border-left: 4px solid #667eea;
        }
        
        .highlight {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #ffc107;
        }
        
        .highlight strong {
            color: #856404;
        }
        
        ul {
            margin-left: 20px;
            line-height: 1.8;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: #667eea;
            color: white;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .samples-display {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            max-height: 150px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦ Î¼ å’Œ log(ÏƒÂ²)ï¼Ÿ</h1>
        
        <div class="grid">
            <!-- å·¦ä¾§ï¼šç†è®ºè§£é‡Š -->
            <div class="card">
                <h2>ğŸ“š ç†è®ºè§£é‡Š</h2>
                
                <div class="highlight">
                    <strong>æ ¸å¿ƒæ€æƒ³ï¼š</strong> æˆ‘ä»¬ä¸æ˜¯é¢„æµ‹ä¸€ä¸ªç¡®å®šçš„å€¼ï¼Œè€Œæ˜¯é¢„æµ‹ä¸€ä¸ª<strong>æ¦‚ç‡åˆ†å¸ƒ</strong>ï¼
                </div>
                
                <h3 style="color: #333; margin-top: 20px;">1ï¸âƒ£ ç¡®å®šæ€§è¾“å‡º vs æ¦‚ç‡æ€§è¾“å‡º</h3>
                <div class="comparison">
                    <div class="comparison-item deterministic">
                        <h3>âŒ ç¡®å®šæ€§</h3>
                        <p><strong>è¾“å‡ºï¼š</strong> z = f(h)</p>
                        <ul>
                            <li>åªæœ‰ä¸€ä¸ªå›ºå®šå€¼</li>
                            <li>æ— æ³•è¡¨è¾¾ä¸ç¡®å®šæ€§</li>
                            <li>æ— æ³•é‡‡æ ·å¤šæ ·æ€§</li>
                        </ul>
                    </div>
                    <div class="comparison-item probabilistic">
                        <h3>âœ… æ¦‚ç‡æ€§</h3>
                        <p><strong>è¾“å‡ºï¼š</strong> z ~ N(Î¼, ÏƒÂ²)</p>
                        <ul>
                            <li>å¯ä»¥é‡‡æ ·æ— é™å¤šä¸ªå€¼</li>
                            <li>è¡¨è¾¾æ¨¡å‹çš„ä¸ç¡®å®šæ€§</li>
                            <li>æ”¯æŒç”Ÿæˆå¤šæ ·åŒ–ç»“æœ</li>
                        </ul>
                    </div>
                </div>
                
                <h3 style="color: #333; margin-top: 20px;">2ï¸âƒ£ é«˜æ–¯åˆ†å¸ƒçš„ä¸¤ä¸ªå…³é”®å‚æ•°</h3>
                <div class="formula">
                    N(z | Î¼, ÏƒÂ²)
                </div>
                <ul>
                    <li><strong>Î¼ (å‡å€¼)</strong>ï¼šåˆ†å¸ƒçš„ä¸­å¿ƒä½ç½®ï¼Œå‘Šè¯‰æˆ‘ä»¬"æœŸæœ›å€¼åœ¨å“ªé‡Œ"</li>
                    <li><strong>ÏƒÂ² (æ–¹å·®)</strong>ï¼šåˆ†å¸ƒçš„ç¦»æ•£ç¨‹åº¦ï¼Œå‘Šè¯‰æˆ‘ä»¬"ä¸ç¡®å®šæ€§æœ‰å¤šå¤§"</li>
                </ul>
                
                <h3 style="color: #333; margin-top: 20px;">3ï¸âƒ£ ä¸ºä»€ä¹ˆç”¨ log(ÏƒÂ²) è€Œä¸æ˜¯ Ïƒï¼Ÿ</h3>
                <ul>
                    <li><strong>æ•°å€¼ç¨³å®šæ€§</strong>ï¼šæ–¹å·®å¿…é¡»ä¸ºæ­£ï¼Œç›´æ¥è¾“å‡ºå®¹æ˜“è¿å</li>
                    <li><strong>èŒƒå›´æ— é™</strong>ï¼šlog(ÏƒÂ²) âˆˆ (-âˆ, +âˆ)ï¼Œç½‘ç»œå¯ä»¥è‡ªç”±è¾“å‡º</li>
                    <li><strong>æ¢¯åº¦æ›´å¥½</strong>ï¼šå¯¹æ•°ç©ºé—´çš„æ¢¯åº¦æ›´å‡åŒ€</li>
                </ul>
                
                <div class="formula">
                    Ïƒ = exp(0.5 Ã— log(ÏƒÂ²)) = exp(log Ïƒ)
                </div>
                
                <h3 style="color: #333; margin-top: 20px;">4ï¸âƒ£ å®é™…åº”ç”¨ï¼šVAE</h3>
                <ul>
                    <li>ç¼–ç å™¨è¾“å‡º Î¼ å’Œ log(ÏƒÂ²)</li>
                    <li>é€šè¿‡é‡å‚æ•°åŒ–é‡‡æ ·ï¼šz = Î¼ + Ïƒ Ã— Îµ</li>
                    <li>è§£ç å™¨æ ¹æ® z é‡å»ºæ•°æ®</li>
                    <li>å¯ä»¥ç”Ÿæˆæ–°æ ·æœ¬ï¼šå›ºå®šÎ¼ï¼Œæ”¹å˜é‡‡æ ·çš„Îµ</li>
                </ul>
            </div>
            
            <!-- å³ä¾§ï¼šäº¤äº’å¼å¯è§†åŒ– -->
            <div class="card">
                <h2>ğŸ® äº¤äº’å¼æ¼”ç¤º</h2>
                
                <div class="controls">
                    <div class="control-group">
                        <label>
                            <span>å‡å€¼ Î¼ (åˆ†å¸ƒä¸­å¿ƒ)</span>
                            <span class="value" id="muValue">0.0</span>
                        </label>
                        <input type="range" id="muSlider" min="-5" max="5" step="0.1" value="0">
                    </div>
                    
                    <div class="control-group">
                        <label>
                            <span>log(ÏƒÂ²) (å¯¹æ•°æ–¹å·®)</span>
                            <span class="value" id="logvarValue">0.0</span>
                        </label>
                        <input type="range" id="logvarSlider" min="-3" max="3" step="0.1" value="0">
                    </div>
                    
                    <div class="control-group">
                        <label>
                            <span>æ ‡å‡†å·® Ïƒ = exp(0.5 Ã— log(ÏƒÂ²))</span>
                            <span class="value" id="sigmaValue">1.0</span>
                        </label>
                    </div>
                </div>
                
                <div class="button-group">
                    <button onclick="sampleOnce()">ğŸ“Š é‡‡æ ·ä¸€æ¬¡</button>
                    <button onclick="sampleMultiple()">ğŸ² é‡‡æ ·100æ¬¡</button>
                    <button onclick="clearSamples()">ğŸ—‘ï¸ æ¸…é™¤é‡‡æ ·</button>
                </div>
                
                <div class="chart-container">
                    <canvas id="distributionChart"></canvas>
                </div>
                
                <div class="samples-display" id="samplesDisplay">
                    é‡‡æ ·ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...
                </div>
            </div>
        </div>
        
        <!-- åº•éƒ¨ï¼šä»£ç ç¤ºä¾‹ -->
        <div class="card">
            <h2>ğŸ’» PyTorch ä»£ç å®ç°</h2>
            <pre style="background: #2d2d2d; color: #f8f8f2; padding: 20px; border-radius: 8px; overflow-x: auto;"><code><span style="color: #66d9ef;">class</span> <span style="color: #a6e22e;">Encoder</span>(nn.Module):
    <span style="color: #66d9ef;">def</span> <span style="color: #a6e22e;">__init__</span>(self, input_dim, latent_dim):
        <span style="color: #66d9ef;">super</span>().__init__()
        self.fc = nn.Linear(input_dim, <span style="color: #ae81ff;">256</span>)
        <span style="color: #75715e;"># è¾“å‡ºä¸¤ä¸ªå‚æ•°ï¼šÎ¼ å’Œ log(ÏƒÂ²)</span>
        self.fc_mu = nn.Linear(<span style="color: #ae81ff;">256</span>, latent_dim)      <span style="color: #75715e;"># å‡å€¼</span>
        self.fc_logvar = nn.Linear(<span style="color: #ae81ff;">256</span>, latent_dim)  <span style="color: #75715e;"># å¯¹æ•°æ–¹å·®</span>
    
    <span style="color: #66d9ef;">def</span> <span style="color: #a6e22e;">forward</span>(self, x):
        h = F.relu(self.fc(x))
        mu = self.fc_mu(h)           <span style="color: #75715e;"># è¾“å‡ºå‡å€¼</span>
        logvar = self.fc_logvar(h)   <span style="color: #75715e;"># è¾“å‡º log(ÏƒÂ²)</span>
        <span style="color: #66d9ef;">return</span> mu, logvar

<span style="color: #66d9ef;">def</span> <span style="color: #a6e22e;">reparameterize</span>(mu, logvar):
    <span style="color: #e6db74;">"""é‡å‚æ•°åŒ–æŠ€å·§"""</span>
    std = torch.exp(<span style="color: #ae81ff;">0.5</span> * logvar)  <span style="color: #75715e;"># Ïƒ = exp(0.5 Ã— log(ÏƒÂ²))</span>
    eps = torch.randn_like(std)     <span style="color: #75715e;"># Îµ ~ N(0, 1)</span>
    z = mu + std * eps               <span style="color: #75715e;"># z = Î¼ + Ïƒ Ã— Îµ</span>
    <span style="color: #66d9ef;">return</span> z</code></pre>
            
            <div class="highlight" style="margin-top: 20px;">
                <strong>å…³é”®ç‚¹ï¼š</strong>
                <ul>
                    <li>ç½‘ç»œè¾“å‡º <code>mu</code> å’Œ <code>logvar</code> ä¸¤ä¸ªå¼ é‡</li>
                    <li>é€šè¿‡ <code>exp(0.5 * logvar)</code> è½¬æ¢ä¸ºæ ‡å‡†å·®</li>
                    <li>ç”¨é‡å‚æ•°åŒ–æŠ€å·§é‡‡æ ·ï¼Œä¿è¯æ¢¯åº¦å¯ä»¥å›ä¼ </li>
                    <li>æ¯æ¬¡é‡‡æ ·éƒ½ä¼šå¾—åˆ°ä¸åŒçš„ z å€¼</li>
                </ul>
            </div>
        </div>
    </div>
    
    <script>
        // ç”Ÿæˆé«˜æ–¯åˆ†å¸ƒçš„æ¦‚ç‡å¯†åº¦å‡½æ•°
        function gaussianPDF(x, mu, sigma) {
            return (1 / (sigma * Math.sqrt(2 * Math.PI))) * 
                   Math.exp(-0.5 * Math.pow((x - mu) / sigma, 2));
        }
        
        // ä»é«˜æ–¯åˆ†å¸ƒé‡‡æ ·
        function sampleGaussian(mu, sigma) {
            // Box-Muller å˜æ¢
            const u1 = Math.random();
            const u2 = Math.random();
            const z = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
            return mu + sigma * z;
        }
        
        // åˆå§‹åŒ–å›¾è¡¨
        let chart;
        let samples = [];
        
        function initChart() {
            const ctx = document.getElementById('distributionChart').getContext('2d');
            
            const xValues = [];
            for (let x = -10; x <= 10; x += 0.1) {
                xValues.push(x);
            }
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: xValues,
                    datasets: [{
                        label: 'æ¦‚ç‡å¯†åº¦å‡½æ•° N(z|Î¼,ÏƒÂ²)',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3
                    }, {
                        label: 'é‡‡æ ·ç‚¹',
                        data: [],
                        type: 'scatter',
                        backgroundColor: '#ff6b6b',
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'æ¦‚ç‡å¯†åº¦',
                                font: { size: 14, weight: 'bold' }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'z å€¼',
                                font: { size: 14, weight: 'bold' }
                            },
                            ticks: {
                                callback: function(value, index, ticks) {
                                    // value æ˜¯ç´¢å¼•ï¼Œéœ€è¦è½¬æ¢ä¸ºå®é™…çš„ x å€¼
                                    const actualValue = this.getLabelForValue(value);
                                    return parseFloat(actualValue).toFixed(2);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { font: { size: 12 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(4);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function updateChart() {
            const mu = parseFloat(document.getElementById('muSlider').value);
            const logvar = parseFloat(document.getElementById('logvarSlider').value);
            const sigma = Math.exp(0.5 * logvar);
            
            // æ›´æ–°æ˜¾ç¤ºå€¼
            document.getElementById('muValue').textContent = mu.toFixed(2);
            document.getElementById('logvarValue').textContent = logvar.toFixed(2);
            document.getElementById('sigmaValue').textContent = sigma.toFixed(2);
            
            // è®¡ç®—PDF
            const xValues = chart.data.labels;
            const pdfValues = xValues.map(x => gaussianPDF(x, mu, sigma));
            
            chart.data.datasets[0].data = pdfValues;
            
            // æ›´æ–°é‡‡æ ·ç‚¹
            const samplePoints = samples.map(s => ({ x: s, y: gaussianPDF(s, mu, sigma) }));
            chart.data.datasets[1].data = samplePoints;
            
            chart.update();
        }
        
        function sampleOnce() {
            const mu = parseFloat(document.getElementById('muSlider').value);
            const logvar = parseFloat(document.getElementById('logvarSlider').value);
            const sigma = Math.exp(0.5 * logvar);
            
            const sample = sampleGaussian(mu, sigma);
            samples.push(sample);
            
            updateSamplesDisplay();
            updateChart();
        }
        
        function sampleMultiple() {
            const mu = parseFloat(document.getElementById('muSlider').value);
            const logvar = parseFloat(document.getElementById('logvarSlider').value);
            const sigma = Math.exp(0.5 * logvar);
            
            for (let i = 0; i < 100; i++) {
                const sample = sampleGaussian(mu, sigma);
                samples.push(sample);
            }
            
            updateSamplesDisplay();
            updateChart();
        }
        
        function clearSamples() {
            samples = [];
            updateSamplesDisplay();
            updateChart();
        }
        
        function updateSamplesDisplay() {
            const display = document.getElementById('samplesDisplay');
            
            if (samples.length === 0) {
                display.textContent = 'é‡‡æ ·ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...';
                return;
            }
            
            const mean = samples.reduce((a, b) => a + b, 0) / samples.length;
            const variance = samples.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / samples.length;
            const std = Math.sqrt(variance);
            
            display.innerHTML = `
                <strong>é‡‡æ ·ç»Ÿè®¡ (å…± ${samples.length} ä¸ªæ ·æœ¬):</strong><br>
                æ ·æœ¬å‡å€¼: ${mean.toFixed(4)}<br>
                æ ·æœ¬æ ‡å‡†å·®: ${std.toFixed(4)}<br>
                æœ€è¿‘5ä¸ªæ ·æœ¬: ${samples.slice(-5).map(s => s.toFixed(3)).join(', ')}
            `;
        }
        
        // åˆå§‹åŒ–
        // window.onload = function() {
        //     initChart();
        //     updateChart();
            
        //     document.getElementById('muSlider').addEventListener('input', updateChart);
        //     document.getElementById('logvarSlider').addEventListener('input', updateChart);
        // };

        function attachChartListeners() {
      const muSlider = document.getElementById('muSlider');
      const logvarSlider = document.getElementById('logvarSlider');
      if (muSlider) muSlider.addEventListener('input', updateChart);
      if (logvarSlider) logvarSlider.addEventListener('input', updateChart);
    }

    // å¯ç”± pageLoader è°ƒç”¨çš„åˆå§‹åŒ–æ¥å£ï¼ˆåŠ¨æ€æ³¨å…¥æ—¶ä½¿ç”¨ï¼‰
    window.initVisualizer = function(meta) {
      try {
        // å¦‚æœ initChart/updateChart åœ¨å¤–éƒ¨è„šæœ¬ä¸­ï¼Œç¡®ä¿å¤–éƒ¨è„šæœ¬å·²åŠ è½½åè°ƒç”¨
        if (typeof initChart === 'function') initChart();
        if (typeof updateChart === 'function') updateChart();
        attachChartListeners();
      } catch (e) {
        console.error('initVisualizer error', e);
      }
    };

    // ä»å…¼å®¹ç›´æ¥æ‰“å¼€ HTML çš„åœºæ™¯
    window.onload = function() {
      if (typeof window.initVisualizer === 'function') {
        window.initVisualizer();
      } else {
        // fallbackï¼Œå¦‚æœå¤–éƒ¨æ²¡æœ‰ initVisualizer
        try {
          if (typeof initChart === 'function') initChart();
          if (typeof updateChart === 'function') updateChart();
          attachChartListeners();
        } catch (e) {
          console.error(e);
        }
      }
    };
    </script>
</body>
</html>