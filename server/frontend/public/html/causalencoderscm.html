<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>为什么需要 μ 和 log(σ²)？</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: white;
            font-size: 2.5em;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .control-group label {
            font-weight: 600;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .control-group .value {
            color: #667eea;
            font-size: 1.2em;
            font-weight: bold;
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }
        
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .comparison-item {
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #ddd;
        }
        
        .comparison-item.deterministic {
            background: #ffe6e6;
            border-color: #ff6b6b;
        }
        
        .comparison-item.probabilistic {
            background: #e6f3ff;
            border-color: #4dabf7;
        }
        
        .comparison-item h3 {
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        
        .comparison-item.deterministic h3 {
            color: #ff6b6b;
        }
        
        .comparison-item.probabilistic h3 {
            color: #4dabf7;
        }
        
        .formula {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 1.1em;
            text-align: center;
            border-left: 4px solid #667eea;
        }
        
        .highlight {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #ffc107;
        }
        
        .highlight strong {
            color: #856404;
        }
        
        ul {
            margin-left: 20px;
            line-height: 1.8;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: #667eea;
            color: white;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .samples-display {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            max-height: 150px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎯 为什么需要 μ 和 log(σ²)？</h1>
        
        <div class="grid">
            <!-- 左侧：理论解释 -->
            <div class="card">
                <h2>📚 理论解释</h2>
                
                <div class="highlight">
                    <strong>核心思想：</strong> 我们不是预测一个确定的值，而是预测一个<strong>概率分布</strong>！
                </div>
                
                <h3 style="color: #333; margin-top: 20px;">1️⃣ 确定性输出 vs 概率性输出</h3>
                <div class="comparison">
                    <div class="comparison-item deterministic">
                        <h3>❌ 确定性</h3>
                        <p><strong>输出：</strong> z = f(h)</p>
                        <ul>
                            <li>只有一个固定值</li>
                            <li>无法表达不确定性</li>
                            <li>无法采样多样性</li>
                        </ul>
                    </div>
                    <div class="comparison-item probabilistic">
                        <h3>✅ 概率性</h3>
                        <p><strong>输出：</strong> z ~ N(μ, σ²)</p>
                        <ul>
                            <li>可以采样无限多个值</li>
                            <li>表达模型的不确定性</li>
                            <li>支持生成多样化结果</li>
                        </ul>
                    </div>
                </div>
                
                <h3 style="color: #333; margin-top: 20px;">2️⃣ 高斯分布的两个关键参数</h3>
                <div class="formula">
                    N(z | μ, σ²)
                </div>
                <ul>
                    <li><strong>μ (均值)</strong>：分布的中心位置，告诉我们"期望值在哪里"</li>
                    <li><strong>σ² (方差)</strong>：分布的离散程度，告诉我们"不确定性有多大"</li>
                </ul>
                
                <h3 style="color: #333; margin-top: 20px;">3️⃣ 为什么用 log(σ²) 而不是 σ？</h3>
                <ul>
                    <li><strong>数值稳定性</strong>：方差必须为正，直接输出容易违反</li>
                    <li><strong>范围无限</strong>：log(σ²) ∈ (-∞, +∞)，网络可以自由输出</li>
                    <li><strong>梯度更好</strong>：对数空间的梯度更均匀</li>
                </ul>
                
                <div class="formula">
                    σ = exp(0.5 × log(σ²)) = exp(log σ)
                </div>
                
                <h3 style="color: #333; margin-top: 20px;">4️⃣ 实际应用：VAE</h3>
                <ul>
                    <li>编码器输出 μ 和 log(σ²)</li>
                    <li>通过重参数化采样：z = μ + σ × ε</li>
                    <li>解码器根据 z 重建数据</li>
                    <li>可以生成新样本：固定μ，改变采样的ε</li>
                </ul>
            </div>
            
            <!-- 右侧：交互式可视化 -->
            <div class="card">
                <h2>🎮 交互式演示</h2>
                
                <div class="controls">
                    <div class="control-group">
                        <label>
                            <span>均值 μ (分布中心)</span>
                            <span class="value" id="muValue">0.0</span>
                        </label>
                        <input type="range" id="muSlider" min="-5" max="5" step="0.1" value="0">
                    </div>
                    
                    <div class="control-group">
                        <label>
                            <span>log(σ²) (对数方差)</span>
                            <span class="value" id="logvarValue">0.0</span>
                        </label>
                        <input type="range" id="logvarSlider" min="-3" max="3" step="0.1" value="0">
                    </div>
                    
                    <div class="control-group">
                        <label>
                            <span>标准差 σ = exp(0.5 × log(σ²))</span>
                            <span class="value" id="sigmaValue">1.0</span>
                        </label>
                    </div>
                </div>
                
                <div class="button-group">
                    <button onclick="sampleOnce()">📊 采样一次</button>
                    <button onclick="sampleMultiple()">🎲 采样100次</button>
                    <button onclick="clearSamples()">🗑️ 清除采样</button>
                </div>
                
                <div class="chart-container">
                    <canvas id="distributionChart"></canvas>
                </div>
                
                <div class="samples-display" id="samplesDisplay">
                    采样结果将显示在这里...
                </div>
            </div>
        </div>
        
        <!-- 底部：代码示例 -->
        <div class="card">
            <h2>💻 PyTorch 代码实现</h2>
            <pre style="background: #2d2d2d; color: #f8f8f2; padding: 20px; border-radius: 8px; overflow-x: auto;"><code><span style="color: #66d9ef;">class</span> <span style="color: #a6e22e;">Encoder</span>(nn.Module):
    <span style="color: #66d9ef;">def</span> <span style="color: #a6e22e;">__init__</span>(self, input_dim, latent_dim):
        <span style="color: #66d9ef;">super</span>().__init__()
        self.fc = nn.Linear(input_dim, <span style="color: #ae81ff;">256</span>)
        <span style="color: #75715e;"># 输出两个参数：μ 和 log(σ²)</span>
        self.fc_mu = nn.Linear(<span style="color: #ae81ff;">256</span>, latent_dim)      <span style="color: #75715e;"># 均值</span>
        self.fc_logvar = nn.Linear(<span style="color: #ae81ff;">256</span>, latent_dim)  <span style="color: #75715e;"># 对数方差</span>
    
    <span style="color: #66d9ef;">def</span> <span style="color: #a6e22e;">forward</span>(self, x):
        h = F.relu(self.fc(x))
        mu = self.fc_mu(h)           <span style="color: #75715e;"># 输出均值</span>
        logvar = self.fc_logvar(h)   <span style="color: #75715e;"># 输出 log(σ²)</span>
        <span style="color: #66d9ef;">return</span> mu, logvar

<span style="color: #66d9ef;">def</span> <span style="color: #a6e22e;">reparameterize</span>(mu, logvar):
    <span style="color: #e6db74;">"""重参数化技巧"""</span>
    std = torch.exp(<span style="color: #ae81ff;">0.5</span> * logvar)  <span style="color: #75715e;"># σ = exp(0.5 × log(σ²))</span>
    eps = torch.randn_like(std)     <span style="color: #75715e;"># ε ~ N(0, 1)</span>
    z = mu + std * eps               <span style="color: #75715e;"># z = μ + σ × ε</span>
    <span style="color: #66d9ef;">return</span> z</code></pre>
            
            <div class="highlight" style="margin-top: 20px;">
                <strong>关键点：</strong>
                <ul>
                    <li>网络输出 <code>mu</code> 和 <code>logvar</code> 两个张量</li>
                    <li>通过 <code>exp(0.5 * logvar)</code> 转换为标准差</li>
                    <li>用重参数化技巧采样，保证梯度可以回传</li>
                    <li>每次采样都会得到不同的 z 值</li>
                </ul>
            </div>
        </div>
    </div>
    
    <script>
        // 生成高斯分布的概率密度函数
        function gaussianPDF(x, mu, sigma) {
            return (1 / (sigma * Math.sqrt(2 * Math.PI))) * 
                   Math.exp(-0.5 * Math.pow((x - mu) / sigma, 2));
        }
        
        // 从高斯分布采样
        function sampleGaussian(mu, sigma) {
            // Box-Muller 变换
            const u1 = Math.random();
            const u2 = Math.random();
            const z = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
            return mu + sigma * z;
        }
        
        // 初始化图表
        let chart;
        let samples = [];
        
        function initChart() {
            const ctx = document.getElementById('distributionChart').getContext('2d');
            
            const xValues = [];
            for (let x = -10; x <= 10; x += 0.1) {
                xValues.push(x);
            }
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: xValues,
                    datasets: [{
                        label: '概率密度函数 N(z|μ,σ²)',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3
                    }, {
                        label: '采样点',
                        data: [],
                        type: 'scatter',
                        backgroundColor: '#ff6b6b',
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '概率密度',
                                font: { size: 14, weight: 'bold' }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'z 值',
                                font: { size: 14, weight: 'bold' }
                            },
                            ticks: {
                                callback: function(value, index, ticks) {
                                    // value 是索引，需要转换为实际的 x 值
                                    const actualValue = this.getLabelForValue(value);
                                    return parseFloat(actualValue).toFixed(2);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { font: { size: 12 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(4);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function updateChart() {
            const mu = parseFloat(document.getElementById('muSlider').value);
            const logvar = parseFloat(document.getElementById('logvarSlider').value);
            const sigma = Math.exp(0.5 * logvar);
            
            // 更新显示值
            document.getElementById('muValue').textContent = mu.toFixed(2);
            document.getElementById('logvarValue').textContent = logvar.toFixed(2);
            document.getElementById('sigmaValue').textContent = sigma.toFixed(2);
            
            // 计算PDF
            const xValues = chart.data.labels;
            const pdfValues = xValues.map(x => gaussianPDF(x, mu, sigma));
            
            chart.data.datasets[0].data = pdfValues;
            
            // 更新采样点
            const samplePoints = samples.map(s => ({ x: s, y: gaussianPDF(s, mu, sigma) }));
            chart.data.datasets[1].data = samplePoints;
            
            chart.update();
        }
        
        function sampleOnce() {
            const mu = parseFloat(document.getElementById('muSlider').value);
            const logvar = parseFloat(document.getElementById('logvarSlider').value);
            const sigma = Math.exp(0.5 * logvar);
            
            const sample = sampleGaussian(mu, sigma);
            samples.push(sample);
            
            updateSamplesDisplay();
            updateChart();
        }
        
        function sampleMultiple() {
            const mu = parseFloat(document.getElementById('muSlider').value);
            const logvar = parseFloat(document.getElementById('logvarSlider').value);
            const sigma = Math.exp(0.5 * logvar);
            
            for (let i = 0; i < 100; i++) {
                const sample = sampleGaussian(mu, sigma);
                samples.push(sample);
            }
            
            updateSamplesDisplay();
            updateChart();
        }
        
        function clearSamples() {
            samples = [];
            updateSamplesDisplay();
            updateChart();
        }
        
        function updateSamplesDisplay() {
            const display = document.getElementById('samplesDisplay');
            
            if (samples.length === 0) {
                display.textContent = '采样结果将显示在这里...';
                return;
            }
            
            const mean = samples.reduce((a, b) => a + b, 0) / samples.length;
            const variance = samples.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / samples.length;
            const std = Math.sqrt(variance);
            
            display.innerHTML = `
                <strong>采样统计 (共 ${samples.length} 个样本):</strong><br>
                样本均值: ${mean.toFixed(4)}<br>
                样本标准差: ${std.toFixed(4)}<br>
                最近5个样本: ${samples.slice(-5).map(s => s.toFixed(3)).join(', ')}
            `;
        }
        
        // 初始化
        // window.onload = function() {
        //     initChart();
        //     updateChart();
            
        //     document.getElementById('muSlider').addEventListener('input', updateChart);
        //     document.getElementById('logvarSlider').addEventListener('input', updateChart);
        // };

        function attachChartListeners() {
      const muSlider = document.getElementById('muSlider');
      const logvarSlider = document.getElementById('logvarSlider');
      if (muSlider) muSlider.addEventListener('input', updateChart);
      if (logvarSlider) logvarSlider.addEventListener('input', updateChart);
    }

    // 可由 pageLoader 调用的初始化接口（动态注入时使用）
    window.initVisualizer = function(meta) {
      try {
        // 如果 initChart/updateChart 在外部脚本中，确保外部脚本已加载后调用
        if (typeof initChart === 'function') initChart();
        if (typeof updateChart === 'function') updateChart();
        attachChartListeners();
      } catch (e) {
        console.error('initVisualizer error', e);
      }
    };

    // 仍兼容直接打开 HTML 的场景
    window.onload = function() {
      if (typeof window.initVisualizer === 'function') {
        window.initVisualizer();
      } else {
        // fallback，如果外部没有 initVisualizer
        try {
          if (typeof initChart === 'function') initChart();
          if (typeof updateChart === 'function') updateChart();
          attachChartListeners();
        } catch (e) {
          console.error(e);
        }
      }
    };
    </script>
</body>
</html>